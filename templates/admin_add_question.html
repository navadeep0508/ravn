{% extends "admin_base.html" %}

{% block page_title %}Add Question{% endblock %}

{% block admin_content %}
<div class="max-w-4xl mx-auto">
    <!-- Header with Breadcrumb -->
    <div class="mb-8">
        <nav class="flex" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{{ url_for('admin_dashboard') }}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-indigo-600">
                        <i class="fas fa-home mr-2"></i>
                        Dashboard
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        <a href="{{ url_for('admin_courses') }}" class="ml-2 text-sm font-medium text-gray-700 hover:text-indigo-600">Courses</a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        <a href="{{ url_for('admin_course_modules', course_id=course.id) }}" class="ml-2 text-sm font-medium text-gray-700 hover:text-indigo-600">{{ course.title }}</a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        <a href="{{ url_for('admin_module_tests', module_id=module.id) }}" class="ml-2 text-sm font-medium text-gray-700 hover:text-indigo-600">{{ module.title }}</a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        <a href="{{ url_for('admin_manage_test', test_id=test.id) }}" class="ml-2 text-sm font-medium text-gray-700 hover:text-indigo-600">{{ test.title }}</a>
                    </div>
                </li>
                <li aria-current="page">
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        <span class="ml-2 text-sm font-medium text-gray-500">Add Question</span>
                    </div>
                </li>
            </ol>
        </nav>
        <h1 class="text-2xl font-bold text-gray-900 mt-4">Add Question to {{ test.title }}</h1>
        <p class="text-gray-600 mt-1">Create a new question for this test</p>
    </div>

    <!-- Main Form -->
    <div class="bg-white shadow-lg rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
            <h2 class="text-lg font-medium text-gray-900">Question Details</h2>
            <p class="text-sm text-gray-500 mt-1">Enter the question information and options.</p>
        </div>

        <form method="POST" class="p-6 space-y-6">

            <!-- Question Text -->
            <div>
                <label for="question_text" class="block text-sm font-medium text-gray-700 mb-1">Question Text <span class="text-red-500">*</span></label>
                <textarea id="question_text" name="question_text" rows="3" required
                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                          placeholder="Enter your question here"></textarea>
            </div>

            <!-- Question Type and Points -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="question_type" class="block text-sm font-medium text-gray-700 mb-1">Question Type <span class="text-red-500">*</span></label>
                    <select id="question_type" name="question_type" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="multiple_choice">Multiple Choice</option>
                    </select>
                </div>
                <div>
                    <label for="points" class="block text-sm font-medium text-gray-700 mb-1">Points</label>
                    <input type="number" id="points" name="points" value="1" min="1" max="100"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
            </div>

            <!-- Multiple Choice Options -->
            <div id="multiple_choice_options" class="space-y-4">
                <label class="block text-sm font-medium text-gray-700">Answer Options</label>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="correct_answer" value="0" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                        <input type="text" name="options[]" placeholder="Option 1" required
                               class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <button type="button" onclick="removeOption(this)" class="text-red-600 hover:text-red-900 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input type="radio" name="correct_answer" value="1" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                        <input type="text" name="options[]" placeholder="Option 2" required
                               class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <button type="button" onclick="removeOption(this)" class="text-red-600 hover:text-red-900 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <button type="button" onclick="addOption()" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-plus mr-2"></i> Add Option
                </button>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                <a href="{{ url_for('admin_manage_test', test_id=test.id) }}"
                   class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancel
                </a>
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-save mr-2"></i> Add Question
                </button>
            </div>
        </form>
    </div>
</div>

<style>
/* Form Input Focus */
input:focus, textarea:focus, select:focus {
    --tw-ring-color: rgba(99, 102, 241, 0.5);
    border-color: #6366F1;
    box-shadow: 0 0 0 1px #6366F1;
}

/* Transition Effects */
input, textarea, select, button, a {
    transition: all 0.2s ease-in-out;
}

/* Hover Effects */
button:hover, a:hover {
    transform: translateY(-1px);
}

/* Option styling */
.option-item {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    padding: 0.75rem;
}

/* Responsive Adjustments */
@media (max-width: 640px) {
    .grid-cols-1 {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function addOption() {
    const optionsContainer = document.querySelector('#multiple_choice_options .space-y-3');
    const optionCount = optionsContainer.children.length;
    const newIndex = optionCount;

    const optionDiv = document.createElement('div');
    optionDiv.className = 'flex items-center space-x-3';
    optionDiv.innerHTML = `
        <input type="radio" name="correct_answer" value="${newIndex}" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
        <input type="text" name="options[]" placeholder="Option ${newIndex + 1}" required
               class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        <button type="button" onclick="removeOption(this)" class="text-red-600 hover:text-red-900 p-2">
            <i class="fas fa-trash"></i>
        </button>
    `;

    optionsContainer.appendChild(optionDiv);
}

function removeOption(button) {
    const optionDiv = button.closest('.flex');
    const optionsContainer = document.querySelector('#multiple_choice_options .space-y-3');

    // If this is not the last option, we need to update the indices of subsequent options
    if (optionDiv !== optionsContainer.lastElementChild) {
        const allOptions = optionsContainer.querySelectorAll('input[name="correct_answer"]');
        const removedIndex = parseInt(optionDiv.querySelector('input[name="correct_answer"]').value);

        // Update indices for all options after the removed one
        for (let i = removedIndex + 1; i < allOptions.length; i++) {
            allOptions[i].value = (i - 1).toString();
        }
    }

    optionDiv.remove();

    // Update the correct answer if the removed option was selected
    const correctAnswerInputs = optionsContainer.querySelectorAll('input[name="correct_answer"]');
    if (correctAnswerInputs.length > 0 && !optionsContainer.querySelector('input[name="correct_answer"]:checked')) {
        correctAnswerInputs[0].checked = true;
    }
}

// Form validation for multiple choice questions only
function validateForm() {
    const questionText = document.getElementById('question_text').value.trim();

    if (!questionText) {
        alert('Question text is required.');
        return false;
    }

    const options = document.querySelectorAll('input[name="options[]"]');
    const correctAnswer = document.querySelector('input[name="correct_answer"]:checked');

    if (options.length < 2) {
        alert('Multiple choice questions must have at least 2 options.');
        return false;
    }

    if (!correctAnswer) {
        alert('Please select the correct answer for this multiple choice question.');
        return false;
    }

    // Check if all options have values
    for (let option of options) {
        if (!option.value.trim()) {
            alert('All options must have text.');
            option.focus();
            return false;
        }
    }

    return true;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
