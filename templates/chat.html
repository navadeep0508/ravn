{% extends "dashboard_base.html" %}

{% block page_title %}Messages{% endblock %}

{% block dashboard_content %}
<!-- Chat Header -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-comments mr-3 text-indigo-600"></i>
                Messages
            </h1>
            <p class="text-gray-600">Connect with your teachers and fellow students</p>
        </div>
        <div class="flex items-center space-x-4">
            <button id="newMessageBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                <i class="fas fa-plus mr-2"></i>
                New Message
            </button>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-200px)]">
    <!-- Conversations List -->
    <div class="lg:col-span-1 bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <!-- Search -->
        <div class="p-4 border-b border-gray-200">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="conversationSearch" placeholder="Search conversations..."
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
        </div>

        <!-- Conversations -->
        <div id="conversationsList" class="overflow-y-auto h-[calc(100%-80px)]">
            {% for conversation in conversations %}
            <div class="conversation-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors {{ 'bg-indigo-50 border-indigo-200' if loop.first else '' }}"
                 data-conversation-id="{{ conversation.id }}"
                 data-participant-id="{{ conversation.teacher_id if current_user.role == 'student' else conversation.student_id }}">
                <div class="flex items-start space-x-3">
                    <!-- Avatar -->
                    <div class="flex-shrink-0">
                        <img src="{{ conversation.teacher_avatar if current_user.role == 'student' else conversation.student_avatar }}"
                             alt="{{ conversation.teacher_name if current_user.role == 'student' else conversation.student_name }}"
                             class="w-12 h-12 rounded-full">
                        {% if conversation.unread_count > 0 %}
                        <div class="absolute -mt-10 -ml-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">{{ conversation.unread_count }}</div>
                        {% endif %}
                    </div>

                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <h3 class="font-semibold text-gray-900 truncate">
                                {{ conversation.teacher_name if current_user.role == 'student' else conversation.student_name }}
                            </h3>
                            <span class="text-xs text-gray-500">{{ conversation.last_message_time | format_datetime }}</span>
                        </div>
                        <p class="text-sm text-gray-600 truncate">{{ conversation.last_message }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Area -->
    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <!-- Chat Header -->
        <div id="chatHeader" class="p-4 border-b border-gray-200 hidden">
            <div class="flex items-center space-x-3">
                <img id="chatAvatar" src="" alt="" class="w-10 h-10 rounded-full">
                <div>
                    <h3 id="chatName" class="font-semibold text-gray-900"></h3>
                    <p id="chatStatus" class="text-sm text-gray-500">Online</p>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messagesContainer" class="h-[400px] overflow-y-auto p-4 space-y-4 hidden">
            <!-- Messages will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="h-[400px] flex items-center justify-center text-center p-8">
            <div>
                <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-comments text-indigo-600 text-3xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Select a conversation</h3>
                <p class="text-gray-500">Choose a conversation from the list to start messaging</p>
            </div>
        </div>

        <!-- Message Input -->
        <div id="messageInput" class="p-4 border-t border-gray-200 hidden">
            <div class="flex space-x-3">
                <div class="flex-1">
                    <textarea id="messageText" rows="1" placeholder="Type your message..."
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                </div>
                <button id="sendMessageBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div id="newMessageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Start New Conversation</h3>
            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-4">
            {% if current_user.role == 'student' %}
            <!-- Students can message their teachers -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Teacher</label>
                <select id="recipientSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Choose a teacher...</option>
                    {% for teacher in teachers %}
                    <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <!-- Teachers can message their students -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Student</label>
                <select id="recipientSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Choose a student...</option>
                    {% for student in students %}
                    <option value="{{ student.id }}">{{ student.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Initial Message</label>
                <textarea id="initialMessage" rows="3" placeholder="Type your first message..."
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>

            <div class="flex space-x-3">
                <button id="cancelNewMessageBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button id="startConversationBtn" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Start Conversation
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom scrollbar for conversations */
#conversationsList::-webkit-scrollbar {
    width: 4px;
}

#conversationsList::-webkit-scrollbar-track {
    background: #f1f5f9;
}

#conversationsList::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
}

#conversationsList::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Message bubbles */
.message-bubble {
    max-width: 70%;
    word-wrap: break-word;
}

.message-sent {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    margin-left: auto;
    border-radius: 18px 18px 4px 18px;
}

.message-received {
    background: #f1f5f9;
    color: #374151;
    margin-right: auto;
    border-radius: 18px 18px 18px 4px;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentConversationId = null;
    let currentRecipientId = null;

    // Elements
    const conversationsList = document.getElementById('conversationsList');
    const messagesContainer = document.getElementById('messagesContainer');
    const emptyState = document.getElementById('emptyState');
    const chatHeader = document.getElementById('chatHeader');
    const messageInput = document.getElementById('messageInput');
    const newMessageModal = document.getElementById('newMessageModal');
    const conversationSearch = document.getElementById('conversationSearch');

    // Conversation click handler
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', function() {
            const conversationId = this.dataset.conversationId;
            const participantId = this.dataset.participantId;

            // Remove active state from all conversations
            document.querySelectorAll('.conversation-item').forEach(conv => {
                conv.classList.remove('bg-indigo-50', 'border-indigo-200');
            });

            // Add active state to clicked conversation
            this.classList.add('bg-indigo-50', 'border-indigo-200');

            loadConversation(conversationId, participantId);
        });
    });

    // New message button
    document.getElementById('newMessageBtn').addEventListener('click', function() {
        newMessageModal.classList.remove('hidden');
    });

    // Close modal
    document.getElementById('closeModalBtn').addEventListener('click', function() {
        newMessageModal.classList.add('hidden');
    });

    // Cancel new message
    document.getElementById('cancelNewMessageBtn').addEventListener('click', function() {
        newMessageModal.classList.add('hidden');
        document.getElementById('initialMessage').value = '';
        document.getElementById('recipientSelect').value = '';
    });

    // Start conversation
    document.getElementById('startConversationBtn').addEventListener('click', function() {
        const recipientId = document.getElementById('recipientSelect').value;
        const initialMessage = document.getElementById('initialMessage').value;

        if (!recipientId || !initialMessage.trim()) {
            alert('Please select a recipient and enter a message');
            return;
        }

        // Create new conversation via API
        fetch('/api/chat/create_conversation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                participant_ids: [recipientId],
                initial_message: initialMessage
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and reset form
                newMessageModal.classList.add('hidden');
                document.getElementById('initialMessage').value = '';
                document.getElementById('recipientSelect').value = '';

                // Optionally redirect to the new conversation
                window.location.href = `/chat/${data.conversation_id}`;
            } else {
                alert('Error creating conversation: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating conversation');
        });
    });

    // Send message
    document.getElementById('sendMessageBtn').addEventListener('click', function() {
        sendMessage();
    });

    // Enter key to send message
    document.getElementById('messageText').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Search conversations
    conversationSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const conversations = document.querySelectorAll('.conversation-item');

        conversations.forEach(conv => {
            const name = conv.querySelector('h3').textContent.toLowerCase();
            const message = conv.querySelector('p').textContent.toLowerCase();

            if (name.includes(searchTerm) || message.includes(searchTerm)) {
                conv.style.display = 'block';
            } else {
                conv.style.display = 'none';
            }
        });
    });

    // Load conversation
    function loadConversation(conversationId, participantId) {
        currentConversationId = conversationId;
        currentRecipientId = participantId;

        // Show chat interface
        emptyState.classList.add('hidden');
        chatHeader.classList.remove('hidden');
        messageInput.classList.remove('hidden');

        // Update chat header
        updateChatHeader(participantId);

        // Load messages
        loadMessages(conversationId);
    }

    // Update chat header
    function updateChatHeader(participantId) {
        // Mock implementation - in real app, fetch participant details
        const participantName = participantId === 'teacher_1' ? 'Dr. Sarah Johnson' :
                               participantId === 'teacher_2' ? 'Prof. Michael Chen' :
                               participantId === 'student_1' ? 'John Doe' : 'Jane Smith';

        document.getElementById('chatName').textContent = participantName;
        document.getElementById('chatAvatar').src = participantId.startsWith('teacher') ?
            'https://ui-avatars.com/api/?name=' + encodeURIComponent(participantName) + '&background=667eea&color=fff&size=40' :
            'https://ui-avatars.com/api/?name=' + encodeURIComponent(participantName) + '&background=764ba2&color=fff&size=40';
    }

    // Load messages
    function loadMessages(conversationId) {
        fetch(`/api/chat/get_messages/${conversationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayMessages(data.messages);
                } else {
                    console.error('Error loading messages:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Display messages
    function displayMessages(messages) {
        messagesContainer.innerHTML = '';

        messages.forEach(message => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-3 ${message.sender_id === '{{ current_user.id }}' ? 'justify-end' : 'justify-start'}`;

            const messageContent = `
                <div class="message-bubble px-4 py-2 ${message.sender_id === '{{ current_user.id }}' ? 'message-sent' : 'message-received'}">
                    <p class="text-sm">${message.content}</p>
                    <p class="text-xs mt-1 opacity-75">${formatTime(message.timestamp)}</p>
                </div>
            `;

            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
        });

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Send message
    function sendMessage() {
        const messageText = document.getElementById('messageText').value.trim();

        if (!messageText || !currentConversationId) {
            return;
        }

        fetch('/api/chat/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                conversation_id: currentConversationId,
                message: messageText
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add message to UI
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3 justify-end';

                const messageContent = `
                    <div class="message-bubble px-4 py-2 message-sent">
                        <p class="text-sm">${data.message.content}</p>
                        <p class="text-xs mt-1 opacity-75">${formatTime(data.message.timestamp)}</p>
                    </div>
                `;

                messageDiv.innerHTML = messageContent;
                messagesContainer.appendChild(messageDiv);

                // Clear input
                document.getElementById('messageText').value = '';

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
                alert('Error sending message: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error sending message');
        });
    }

    // Start new conversation
    function startNewConversation(recipientId, initialMessage) {
        // Mock implementation - in real app, create conversation and send initial message
        alert(`Starting conversation with ${recipientId} and sending initial message: "${initialMessage}"`);

        // Close modal and reset form
        newMessageModal.classList.add('hidden');
        document.getElementById('initialMessage').value = '';
        document.getElementById('recipientSelect').value = '';
    }

    // Format time
    function formatTime(timestamp) {
        if (!timestamp) return '';

        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) { // Less than 1 minute
            return 'Just now';
        } else if (diff < 3600000) { // Less than 1 hour
            return `${Math.floor(diff / 60000)}m ago`;
        } else if (diff < 86400000) { // Less than 1 day
            return `${Math.floor(diff / 3600000)}h ago`;
        } else {
            return date.toLocaleDateString();
        }
    }
});
</script>
{% endblock %}
