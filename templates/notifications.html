{% extends "dashboard_base.html" %}

{% block page_title %}Notifications{% endblock %}

{% block dashboard_content %}
<!-- Notifications Header -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-bell mr-3 text-indigo-600"></i>
                Notifications
            </h1>
            <p class="text-gray-600">Stay updated with your latest activity and important announcements</p>
        </div>
        <div class="flex items-center space-x-4">
            <!-- Notification Stats -->
            <div class="hidden md:flex items-center space-x-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-indigo-600">{{ total_notifications }}</div>
                    <div class="text-sm text-gray-500">Total</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-500">{{ unread_count }}</div>
                    <div class="text-sm text-gray-500">Unread</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-500">{{ high_priority_count }}</div>
                    <div class="text-sm text-gray-500">High Priority</div>
                </div>
            </div>
            <!-- Mark All Read Button -->
            <button id="markAllReadBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                <i class="fas fa-check-double mr-2"></i>
                Mark All Read
            </button>
        </div>
    </div>
</div>

<!-- Filter Tabs -->
<div class="mb-6">
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button class="notification-filter active whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600"
                    data-filter="all">
                All Notifications ({{ total_notifications }})
            </button>
            <button class="notification-filter whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                    data-filter="unread">
                Unread ({{ unread_count }})
            </button>
            <button class="notification-filter whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                    data-filter="high">
                High Priority ({{ high_priority_count }})
            </button>
        </nav>
    </div>
</div>

<!-- Notifications List -->
<div id="notificationsContainer" class="space-y-4">
    {% for notification in notifications %}
    <div class="notification-item bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow {{ 'opacity-60' if notification.read else '' }} {{ 'border-l-4 border-l-red-500' if notification.priority == 'high' else 'border-l-4 border-l-blue-500' if notification.priority == 'medium' else 'border-l-4 border-l-gray-300' }}"
         data-id="{{ notification.id }}"
         data-type="{{ notification.type }}"
         data-priority="{{ notification.priority }}"
         data-read="{{ notification.read }}">

        <div class="flex items-start space-x-4">
            <!-- Notification Icon -->
            <div class="flex-shrink-0">
                <div class="w-10 h-10 rounded-full flex items-center justify-center {{ 'bg-red-100' if notification.priority == 'high' else 'bg-blue-100' if notification.priority == 'medium' else 'bg-gray-100' }}">
                    <i class="fas {{ notification.icon }} {{ 'text-red-600' if notification.priority == 'high' else 'text-blue-600' if notification.priority == 'medium' else 'text-gray-600' }}"></i>
                </div>
                {% if not notification.read %}
                <div class="absolute -mt-8 -ml-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                {% endif %}
            </div>

            <!-- Notification Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">
                            {{ notification.title }}
                            {% if notification.priority == 'high' %}
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                High Priority
                            </span>
                            {% endif %}
                        </h3>
                        <p class="text-gray-600 mb-2">{{ notification.message }}</p>

                        <!-- Course/Student Info -->
                        {% if notification.course_name %}
                        <div class="flex items-center text-sm text-gray-500 mb-2">
                            <i class="fas fa-graduation-cap mr-2"></i>
                            <span>{{ notification.course_name }}</span>
                            {% if notification.student_name %}
                            <span class="mx-2">â€¢</span>
                            <span>Student: {{ notification.student_name }}</span>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Timestamp -->
                        <div class="text-xs text-gray-400">
                            {{ notification.timestamp | format_datetime }}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center space-x-2 ml-4">
                        {% if not notification.read %}
                        <button class="mark-read-btn text-gray-400 hover:text-indigo-600 transition-colors"
                                data-notification-id="{{ notification.id }}"
                                title="Mark as read">
                            <i class="fas fa-check"></i>
                        </button>
                        {% endif %}
                        <button class="text-gray-400 hover:text-red-600 transition-colors"
                                title="Delete notification">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Empty State -->
<div id="emptyState" class="hidden text-center py-12">
    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-bell-slash text-gray-400 text-3xl"></i>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No notifications</h3>
    <p class="text-gray-500">You're all caught up! No new notifications at the moment.</p>
</div>

<style>
/* Custom scrollbar for notifications */
#notificationsContainer::-webkit-scrollbar {
    width: 6px;
}

#notificationsContainer::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

#notificationsContainer::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

#notificationsContainer::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Notification animations */
.notification-item {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Filter tab animations */
.notification-filter {
    position: relative;
    transition: all 0.2s ease;
}

.notification-filter.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: #4f46e5;
    border-radius: 1px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const filterButtons = document.querySelectorAll('.notification-filter');
    const notificationsContainer = document.getElementById('notificationsContainer');
    const emptyState = document.getElementById('emptyState');

    // Mark all read button
    const markAllReadBtn = document.getElementById('markAllReadBtn');

    // Mark individual notification as read
    const markReadButtons = document.querySelectorAll('.mark-read-btn');

    // Filter notifications
    function filterNotifications(filterType) {
        const notifications = document.querySelectorAll('.notification-item');
        let visibleCount = 0;

        notifications.forEach(notification => {
            const type = notification.dataset.type;
            const priority = notification.dataset.priority;
            const isRead = notification.dataset.read === 'true';

            let shouldShow = false;

            switch(filterType) {
                case 'all':
                    shouldShow = true;
                    break;
                case 'unread':
                    shouldShow = !isRead;
                    break;
                case 'high':
                    shouldShow = priority === 'high';
                    break;
            }

            if (shouldShow) {
                notification.style.display = 'block';
                visibleCount++;
            } else {
                notification.style.display = 'none';
            }
        });

        // Show empty state if no notifications visible
        if (visibleCount === 0) {
            notificationsContainer.style.display = 'none';
            emptyState.style.display = 'block';
        } else {
            notificationsContainer.style.display = 'block';
            emptyState.style.display = 'none';
        }
    }

    // Filter button click handlers
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active', 'border-indigo-500', 'text-indigo-600'));
            filterButtons.forEach(btn => btn.classList.add('border-transparent', 'text-gray-500'));

            // Add active class to clicked button
            this.classList.add('active', 'border-indigo-500', 'text-indigo-600');
            this.classList.remove('border-transparent', 'text-gray-500');

            // Filter notifications
            const filterType = this.dataset.filter;
            filterNotifications(filterType);
        });
    });

    // Mark individual notification as read
    markReadButtons.forEach(button => {
        button.addEventListener('click', function() {
            const notificationId = this.dataset.notificationId;
            const notification = this.closest('.notification-item');

            // Mark as read visually
            notification.classList.add('opacity-60');
            notification.dataset.read = 'true';
            this.remove();

            // Make API call to mark as read
            fetch(`/notifications/${notificationId}/read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update unread count in header
                    updateNotificationCounts();
                }
            })
            .catch(error => {
                console.error('Error marking notification as read:', error);
            });
        });
    });

    // Mark all notifications as read
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
            // Mark all visible notifications as read
            const visibleNotifications = document.querySelectorAll('.notification-item[style*="block"]');
            visibleNotifications.forEach(notification => {
                notification.classList.add('opacity-60');
                notification.dataset.read = 'true';

                // Remove mark as read buttons
                const markReadBtn = notification.querySelector('.mark-read-btn');
                if (markReadBtn) {
                    markReadBtn.remove();
                }
            });

            // Make API call to mark all as read
            fetch('/notifications/mark-all-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateNotificationCounts();
                }
            })
            .catch(error => {
                console.error('Error marking all notifications as read:', error);
            });
        });
    }

    // Update notification counts in header
    function updateNotificationCounts() {
        const unreadNotifications = document.querySelectorAll('.notification-item[data-read="false"]');
        const highPriorityNotifications = document.querySelectorAll('.notification-item[data-priority="high"]');

        // Update the stats in the header if they exist
        const unreadCountElement = document.querySelector('.text-red-500');
        const highPriorityCountElement = document.querySelector('.text-orange-500');

        if (unreadCountElement) {
            unreadCountElement.textContent = unreadNotifications.length;
        }
        if (highPriorityCountElement) {
            highPriorityCountElement.textContent = highPriorityNotifications.length;
        }

        // Update filter button counts
        const unreadFilterBtn = document.querySelector('[data-filter="unread"]');
        const highPriorityFilterBtn = document.querySelector('[data-filter="high"]');

        if (unreadFilterBtn) {
            unreadFilterBtn.textContent = `Unread (${unreadNotifications.length})`;
        }
        if (highPriorityFilterBtn) {
            highPriorityFilterBtn.textContent = `High Priority (${highPriorityNotifications.length})`;
        }
    }

    // Initialize with "All" filter
    filterNotifications('all');
});
</script>
{% endblock %}
